<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Swords &amp; Wizardry Character Generator</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


    <style type="text/css">
        #dump {
            font-size: 18pt;
            font-weight: bold;
        }

        #character-details {
            float: left;
            width: 300px;
        }

        #character-details .input-group-addon {
            min-width: 160px;
            text-align: left;
        }

        #race-group input[readonly] {
            cursor: default;
        }

        #class-group input[readonly] {
            cursor: default;
        }
    </style>

    <script src="jquery-2.1.1.min.js"></script>
    <script src="handlebars-v2.0.0.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

    <script id="inventory-item-template" type="text/x-handlebars-template">
        <div class="row">
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-addon">Item</span>
                    <span class="form-control">{{name}}</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-addon">Damage</span>
                    <span class="form-control">{{damage}}</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-addon">Armor Class</span>
                    <span class="form-control">{{armorClass}}</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-addon">Weight</span>
                    <span class="form-control">{{weight}}</span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group">
                    <span class="input-group-addon">Quantity</span>
                    <span class="form-control quantity">{{quantity}}</span>
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-success">+</button>
                <button class="btn btn-danger">-</button>
            </div>
        </div>
    </script>
    <script>
        "use strict";

        function rollDie(die) {
            return Math.floor(Math.random() * die) + 1;
        }

        function roll(die, count) {
            var result = [];
            for (var i = 0; i < count; ++i) {
                result.push(rollDie(die));
            }
            return result;
        }

        function sumRoll(die, count) {
            return roll(die, count).reduce(function(a, b) {
                return a + b;
            });
        }

        function generateAttributes() {
            return {
                strength: sumRoll(6, 3),
                dexterity: sumRoll(6, 3),
                constitution: sumRoll(6, 3),
                intelligence: sumRoll(6, 3),
                wisdom: sumRoll(6, 3),
                charisma: sumRoll(6, 3)
            };
        }

        function getModifier(score, scoreVector, modifierVector) {
            if (scoreVector.length != modifierVector.length) {
                throw new Error("Score vector differs in length from modifier vector");
            }

            for (var i = 0; i < scoreVector.length; i++) {
                if (scoreVector[i] >= score) {
                    return modifierVector[i];
                }
            }

            throw new Error("Unable to find score " + score + " in score vector");
        }

        function computeStrengthModifiers(character) {
            var scoreVector = [4, 6, 8, 12, 15, 16, 17, 18];

            var modifiers = character.modifiers;
            var strength = character.attributes.strength;

            modifiers.to_hit = getModifier(strength, scoreVector, [-2, -1, 0, 0, 1, 1, 2, 2]);
            modifiers.damage = getModifier(strength, scoreVector, [-1, 0, 0, 0, 0, 1, 2, 3]);
            modifiers.open_doors = getModifier(strength, scoreVector, ['1', '1', '1-2', '1-2', '1-2', '1-3', '1-4', '1-5']);
            modifiers.carry = getModifier(strength, scoreVector, [-10, -5, 0, 5, 10, 15, 30, 30]);

            if (character.class !== 'fighter') {
                modifiers.to_hit = Math.min(modifiers.to_hit, 0);
                modifiers.damage = Math.min(modifiers.damage, 0);
            }
        }

        function computeDexterityModifiers(character) {
            var scoreVector = [8, 12, 18];

            var modifiers = character.modifiers;
            var dexterity = character.attributes.dexterity;

            modifiers.to_hit_missile = getModifier(dexterity, scoreVector, [-1, 0, 1]);
            modifiers.armor = getModifier(dexterity, scoreVector, [-1, 0, 1]);
        }

        function computeConstitutionModifiers(character) {
            var scoreVector = [8, 12, 18];

            var modifiers = character.modifiers;
            var constitution = character.attributes.constitution;

            modifiers.hit_point = getModifier(constitution, scoreVector, [-1, 0, 1]);
            modifiers.raise_dead_survival = getModifier(constitution, scoreVector, ['50%', '75%', '100%']);
        }

        function computeIntelligenceModifiers(character) {
            var scoreVector = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18];

            var modifiers = character.modifiers;
            var intelligence = character.attributes.intelligence;

            modifiers.max_additional_languages = getModifier(intelligence, scoreVector, [0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6]);
            modifiers.max_spell_level = getModifier(intelligence, scoreVector, [4, 5, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9]);
            modifiers.new_spell_chance = getModifier(intelligence, scoreVector, ['30%', '40%', '45%', '50%', '50%', '55%', '65%', '65%', '75%', '75%', '85%', '95%']);
            modifiers.min_spells_per_level = getModifier(intelligence, scoreVector, [2, 3, 3, 4, 4, 4, 5, 5, 6, 6, 7, 8]);
            modifiers.max_spells_per_level = getModifier(intelligence, scoreVector, [4, 5, 5, 6, 6, 6, 8, 8, 10, 10, 'All', 'All']);
        }

        function computeWisdomModifiers(character) {
            if (character.attributes.wisdom >= 15)
                character.modifiers.xp_bonus += 5;
        }

        function computeCharismaModifiers(character) {
            var scoreVector = [4, 6, 8, 12, 15, 17, 18];

            character.modifiers.max_special_hirelings = getModifier(character.attributes.intelligence, scoreVector, [1, 2, 3, 4, 5, 6, 7]);
        }

        function computeThiefAbilities(character, level) {
            var abilities = {
                climbWalls: 84 + level,
                delicateTasks: Math.min(level < 9 ? 10 + level * 5 : (level - 3) * 10, 100),
                hearSounds: getModifier(level, [2, 6, 10, 100], ['3 in 6', '4 in 6', '5 in 6', '6 in 6']),
                hideInShadows: Math.min(level < 8 ? 5 + level * 5 : 15 + level * 5, 100),
                moveSilently: Math.min(level < 7 ? 15 + level * 5 : (level - 2) * 10, 100),
                openLocks: Math.min(level < 8 ? 5 + level * 5 : 5 + (level - 3) * 10, 100)
            };

            switch (character.race) {
                case 'dwarf':
                    abilities.delicateTasks += 10;
                    abilities.hideInShadows += 5;
                    abilities.moveSilently += 5;
                    abilities.openLocks += 5;
                    break;
                case 'elf':
                    abilities.hideInShadows += 15;
                    abilities.moveSilently += 10;
                    break;
                case 'halfling':
                    abilities.delicateTasks += 5;
                    abilities.hideInShadows += 10;
                    abilities.moveSilently += 10;
                    abilities.openLocks += 10;
                    break;
            }

            return abilities;
        }

        function computeRaceBonuses(character) {
            var bonuses = character.bonuses;

            switch (character.race) {
                case 'dwarf':
                    bonuses.push('+4 on saving throws against magic');
                    bonuses.push('easily take note of features of stonework');
                    bonuses.push('darkvision');

                    if (character.class !== 'fighter' && character.class !== 'thief')
                        throw new Error('Invalid class for dwarvish character');

                    break;
                case 'elf':
                    bonuses.push('darkvision');
                    bonuses.push('4 in 6 chance to find secret doors when searching');
                    bonuses.push('1 in 6 chance to find secret doors when not searching');

                    if (['fighter', 'magic-user', 'thief'].indexOf(character.class) === -1)
                        throw new Error('Invalid class for elven character');

                    break;
                case 'half-elf':
                    bonuses.push('darkvision');
                    bonuses.push('4 in 6 chance to find secret doors when searching');

                    if (['fighter', 'magic-user', 'cleric'].indexOf(character.class) === -1)
                        throw new Error('Invalid class for half-elven character');

                    break;
                case 'halfling':
                    bonuses.push('+4 on saving throws against magic');
                    bonuses.push('+1 when using missile weapons');

                    if (['fighter', 'thief'].indexOf(character.class) === -1)
                        throw new Error('Invalid class for halfling character');

                    break;
                case 'human':
                    break;
                default:
                    throw new Error("Invalid race " + character.race);
            }

            if (character.race !== 'human' && ['assassin', 'druid', 'monk', 'paladin', 'ranger'].indexOf(character.class) !== -1) {
                throw new Error('Invalid class for non-human character');
            }
        }

        function computeClassBonuses(character) {
            var abilities = character.abilities;

            switch (character['class']) {
                case 'cleric':
                    character.modifiers.xp_bonus += 5;
                    abilities.push('spell casting');
                    abilities.push('turn undead');
                    abilities.push('+2 bonus on saving throw rolls against being paralyzed or poisoned');
                    break;
                case 'fighter':
                    character.modifiers.xp_bonus += 5;
                    abilities.push('one attack per level each round against creatures with 1HD or less');
                    abilities.push('on a Dexterity score of 14 or better Fighters can fight on the defensive (parry)');
                    abilities.push('Fighters with a high Strength can have bonuses to hit and on damage');
                    break;
                case 'magic-user':
                    character.modifiers.xp_bonus += 5;
                    abilities.push('spell casting');
                    abilities.push('+2 on all saving throw rolls against spells, including spells from magic wands and staffs');
                    break;
                case 'thief':
                    character.modifiers.xp_bonus += 5;
                    character.thiefAbilities = computeThiefAbilities(character, 1);
                    abilities.push('+4 to hit and double damage when attacking with surprise, from behind (backstab)');
                    abilities.push('+2 bonus on saving throws against devices, including traps, magical wands or staffs, and other magical devices');
                    break;
                default:
                    throw new Error("Unsupported class " + character['class']);
            }
        }

        function makeCharacter() {
            return {
                attributes: {
                    strength: parseInt($('#strength').val()),
                    dexterity: parseInt($('#dexterity').val()),
                    constitution: parseInt($('#constitution').val()),
                    intelligence: parseInt($('#intelligence').val()),
                    wisdom: parseInt($('#wisdom').val()),
                    charisma: parseInt($('#charisma').val()),
                },
                race: $('#race').val(),
                'class': $('#class').val(),
                modifiers: {
                    xp_bonus: 0
                },
                bonuses: [],
                abilities: [],
                inventory: [],
                armor_class: 0,
                weight: 0,
                gold: 0,
                xp: 0
            };
        }

        function computeCharacterStats(character) {
            computeStrengthModifiers(character);
            computeDexterityModifiers(character);
            computeConstitutionModifiers(character);
            computeIntelligenceModifiers(character);
            computeWisdomModifiers(character);
            computeCharismaModifiers(character);

            computeRaceBonuses(character);
            computeClassBonuses(character);

            return character;
        }

        function dumpCharacter(character) {
            var buffer = "";
            buffer += "Modifiers\n";
            for (var key in character.modifiers) {
                buffer += "  " + key + ": " + character.modifiers[key] + "\n";
            }
            buffer += "\n";
            buffer += "Abilities\n";
            for (var i = 0; i < character.abilities.length; ++i) {
                buffer += "  " + character.abilities[i] + "\n";
            }

            if (character.hasOwnProperty('thiefAbilities')) {
                buffer += "\n";
                buffer += "Thief abilities\n";
                for (var key in character.thiefAbilities) {
                    buffer += "  " + key + ": " + character.thiefAbilities[key] + "\n";
                }
            }

            $("#dump").text(buffer);
        }

        var inventoryItemTemplate;
        var character;

        function saveState() {
            localStorage["character"] = JSON.stringify(character);
        }

        function addInventoryLine(item) {
            $('#inventory-list').append(inventoryItemTemplate(item));

            character.weight += item.weight * item.quantity;

            $('#weight-carried').val(character.weight);

            var domNode = $('#inventory-list').last();
            domNode.find('.btn-success').click(function () {
                item.quantity++;
                character.weight += item.weight;

                $('#weight-carried').val(character.weight);

                domNode.find('.quantity').text(item.quantity);
            });

            domNode.find('.btn-danger').click(function () {
                if (item.quantity === 0) {
                    return;
                }

                item.quantity--;
                character.weight -= item.weight;

                $('#weight-carried').val(character.weight);

                domNode.find('.quantity').text(item.quantity);
            });
        }

        function loadState() {
            var data = localStorage["character"];
            if (data) {
                character = JSON.parse(data);

                dumpCharacter(character);

                $('#strength').val(character.attributes.intelligence);
                $('#dexterity').val(character.attributes.dexterity);
                $('#constitution').val(character.attributes.constitution);
                $('#intelligence').val(character.attributes.intelligence);
                $('#wisdom').val(character.attributes.wisdom);
                $('#charisma').val(character.attributes.charisma);

                $('#race').val(character.race);
                $('#race-group a').text(character.race);

                $('#class').val(character['class']);
                $('#class-group a').text(character['class']);

                $('#armor-class').val(character.armor_class);
                $('#weight-carried').val(character.weight);
                $('#gold-pieces').val(character.gold);
                $('#experience-points').val(character.xp);

                for (var i = 0; i < character.inventory.length; ++i) {
                    addInventoryLine(character.inventory[i]);
                }
            }
        }

        $(document).ready(function () {
            inventoryItemTemplate = Handlebars.compile($('#inventory-item-template').html());

            var characterRace = $('#race');
            var characterClass = $('#class');
            $('#race-group a').click(function () {
                characterRace.val($(this).text());
            });
            $('#class-group a').click(function () {
                characterClass.val($(this).text());
            });

            $('#roll-attributes').click(function () {
                var scores = generateAttributes();
                for (var attr in scores) {
                    $('#' + attr).val(scores[attr]);
                }
            });
            $('#generate').click(function () {
                try {
                    character = makeCharacter();
                    computeCharacterStats(character);

                    $('#armor-class').val(character.armor_class);
                    $('#weight-carried').val(character.weight);
                    $('#gold-pieces').val(character.gold);
                    $('#experience-points').val(character.xp);

                    dumpCharacter(character);

                    saveState();
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            $('#save').click(function () {
                saveState();
            });

            $('#weight-carried').change(function () {
                try {
                    var weightCarried = parseFloat($(this).val());
                    if (weightCarried !== character.weight) {
                        character.weight = weightCarried;
                        saveState();
                    }
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            $('#gold-pieces').change(function () {
                try {
                    var goldPieces = parseFloat($(this).val());
                    if (goldPieces !== character.gold) {
                        character.gold = goldPieces;
                        saveState();
                    }
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            $('#experience-points').change(function () {
                try {
                    var experiencePoints = parseInt($(this).val());
                    if (experiencePoints !== character.xp) {
                        character.xp = experiencePoints;
                        saveState();
                    }
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            $('#armor-class').change(function () {
                try {
                    var armorClass = parseInt($(this).val());
                    if (armorClass !== character.armor_class) {
                        character.armor_class = armorClass;
                        saveState();
                    }
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            $('#inventory-add').click(function () {
                try {
                    var name = $('#name').val();
                    var damage = $('#damage').val();
                    var armorClass = $('#armor-class2').val();
                    var weight = parseFloat($('#weight').val());
                    var quantityString = $('#quantity').val();
                    
                    var quantity;
                    if (quantityString === "") {
                        quantity = 1;
                    } else {
                        quantity = parseInt(quantityString);
                    }

                    var found = false;
                    for (var i = 0; i < character.inventory.length; ++i) {
                        if (character.inventory[i].name === name) {
                            found = true;

                            character.inventory[i].quantity += quantity;
                            character.weight += weight * quantity;
                            
                            $('#weight-carried').val(character.weight);

                            $('#inventory-list').eq(i).find('.quantity').text(character.inventory[i].quantity);

                            saveState();
                            break;
                        }
                    }

                    if (!found) {
                        var item = {
                            name: name,
                            damage: damage,
                            armorClass: armorClass,
                            weight: weight,
                            quantity: quantity
                        };

                        character.inventory.push(item);

                        addInventoryLine(item);

                        saveState();
                    }
                } catch (e) {
                    $('#status').val(e.message);
                }
            });

            loadState();
        });
    </script>
</head>
<body>
    <div id="character-details">
        <div id="attribute-group">
            <div class="input-group">
                <label for="strength" class="input-group-addon">Strength</label>
                <input id="strength" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="dexterity" class="input-group-addon">Dexterity</label>
                <input id="dexterity" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="constitution" class="input-group-addon">Constitution</label>
                <input id="constitution" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="intelligence" class="input-group-addon">Intelligence</label>
                <input id="intelligence" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="wisdom" class="input-group-addon">Wisdom</label>
                <input id="wisdom" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="charisma" class="input-group-addon">Charisma</label>
                <input id="charisma" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label for="armor-class" class="input-group-addon">Armor Class</label>
                <input id="armor-class" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label class="input-group-addon">Weight Carried</label>
                <input id="weight-carried" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label class="input-group-addon">Gold Pieces</label>
                <input id="gold-pieces" type="text" class="form-control" />
            </div>
            <div class="input-group">
                <label class="input-group-addon">Experience Points</label>
                <input id="experience-points" type="text" class="form-control" />
            </div>
        </div>

        <div class="input-group" id="race-group">
            <div class="input-group">
                <span class="input-group-addon">Race</span>
                <input id="race" type="text" class="form-control" readonly="readonly" value="dwarf" />
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                        <li><a href="#">dwarf</a></li>
                        <li><a href="#">elf</a></li>
                        <li><a href="#">halfling</a></li>
                        <li><a href="#">human</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="input-group" id="class-group">
            <div class="input-group">
                <span class="input-group-addon">Class</span>
                <input id="class" type="text" class="form-control" readonly="readonly" value="cleric" />
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                        <li><a href="#">cleric</a></li>
                        <li><a href="#">fighter</a></li>
                        <li><a href="#">magic-user</a></li>
                        <li><a href="#">thief</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-default" id="roll-attributes">Roll attributes</button>
        <button type="button" class="btn btn-default" id="generate">Generate</button>
    </div>
    <div style="float: left;">
        <textarea id="dump" rows="20" cols="80"></textarea>
    </div>
    <div style="clear: both;"></div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Inventory</h3>
        </div>
        <div id="inventory-list" class="panel-body" />
    </div>
    <p />
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-2">
                    <div class="input-group">
                        <label for="name" class="input-group-addon">Item</label>
                        <input type="text" id="name" class="form-control" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="input-group">
                        <label for="damage" class="input-group-addon">Damage</label>
                        <input type="text" id="damage" class="form-control" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="input-group">
                        <label for="armor-class2" class="input-group-addon">Armor Class</label>
                        <input type="text" id="armor-class2" class="form-control" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="input-group">
                        <label for="weight" class="input-group-addon">Weight</label>
                        <input type="text" id="weight" class="form-control" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="input-group">
                        <label for="quantity" class="input-group-addon">Quantity</label>
                        <input type="text" id="quantity" class="form-control" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <button id="inventory-add" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>
    <div>
        <button id="save" class="btn btn-success">Save</button>
    </div>
    <p />
    <div>
        <input type="text" id="status" style="width:50%" />
    </div>
</body>
</html>
